<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices"/>
  <meta name="product" content="F5 BIG-IP Resources for Terraform"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2023-04-26 11:52:19"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 BIG-IP Resources for Terraform" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices &#8212; F5 Modules for Terraform</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/table_styling.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Scenario #5: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on a single device" href="awaf-policybuildersingle.html" />
    <link rel="prev" title="Scenario #3: Migrating a WAF Policy from one BIG-IP to another BIG-IP" href="awaf-migrate.html" />

  
    

  
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="dismiss">
      <button type="button" class="btn btn-info navbar-btn site-hidden">
        <i class="fa fa-align-justify"></i>
      </button>
    </div>
    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 BIG-IP Resources for Terraform  </h5>
        
<div id="searchbox" role="search">
  <form class="search" action="../../search.html" method="get">
    <input type="text" class="search" name="q" placeholder=" Search..." />
    <button type="submit" class="btn btn-info navbar-btn"><i class="fa fa-search"></i></button>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">F5 Terraform Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">F5 Terraform Resources Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuring.html">Configuring Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
</ul>
<p class="caption"><span class="caption-text">F5 BIG-IP Provider</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index-bigip.html">F5 BIG-IP Provider Overview</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index-bigip.html#releases-and-versioning">Releases and Versioning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">F5 BIG-IP Provider Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bigip-modules/index.html">F5 BIG-IP Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../as3-integration.html">AS3 Integration with Terraform</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced WAF Integration with Terraform</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-usage">Example Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#integration-resources-and-data-sources">Integration Resources and Data Sources</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#quickstart-and-lab-guides">Quickstart and Lab Guides</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../fast-integration/index.html">FAST Integration with Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../do-integration.html">Declarative Onboarding Integration with Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bigiq-licensing.html">Licensing BIG-IP with BIG-IQ</a></li>
</ul>
<p class="caption"><span class="caption-text">F5OS Provider</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/index-f5os.html">F5OS Resources for Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/release-notes.html">F5OS Provider Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/f5os-modules.html">F5OS Tenant Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/f5os-qsg.html">F5OS Quick Start Guide</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices</a><ul>
<li><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li><a class="reference internal" href="#policy-creation">Policy Creation</a></li>
<li><a class="reference internal" href="#simulate-a-waf-policy-workflow">Simulate a WAF Policy workflow</a><ul>
<li><a class="reference internal" href="#enforcing-attack-signatures-on-the-qa-environment">Enforcing attack signatures on the QA environment</a></li>
</ul>
</li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
            <nav class="site-breadcrumb-nav site-nav">
          <ul class="site-breadcrumb-list">
            <li class="breadcrumb-item"><button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>&#x20 <a href="/">CloudDocs Home</a> &gt; <a href="../../index.html">F5 BIG-IP Resources for Terraform </a> &gt; Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices</li>
          </ul>
      </nav>
      
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="scenario-4-managing-an-f5-big-ip-advanced-waf-policy-on-different-devices">
<span id="awaf-multiple"></span><h1>Scenario #4: Managing an F5 BIG-IP Advanced WAF Policy on different devices<a class="headerlink" href="#scenario-4-managing-an-f5-big-ip-advanced-waf-policy-on-different-devices" title="Permalink to this headline">¶</a></h1>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://github.com/fchmainy/awaf_tf_docs/tree/main/4.multiple">https://github.com/fchmainy/awaf_tf_docs/tree/main/4.multiple</a></p>
</div>
<p>The goal of this lab is to manage an F5 BIG-IP Advanced WAF Policy on multiple devices, including:</p>
<ul class="simple">
<li>Different standalone devices serving the same applications</li>
<li>Different devices serving different purposes: for example, changes tested first on a QA/Test BIG-IP before applying into production.</li>
</ul>
<div class="section" id="pre-requisites">
<h2>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<p>On the BIG-IP:</p>
<ul class="simple">
<li>BIG-IP version 16.1 or newer</li>
<li>Advanced WAF Provisioned</li>
<li>Credentials with REST API access</li>
</ul>
<p>On Terraform:</p>
<ul class="simple">
<li>Using F5 BIG-IP provider version 1.15.0 or newer</li>
<li>Using Hashicorp versions following <a class="reference internal" href="../index-bigip.html#versions"><span class="std std-ref">Releases and Versioning</span></a></li>
</ul>
</div>
<div class="section" id="policy-creation">
<h2>Policy Creation<a class="headerlink" href="#policy-creation" title="Permalink to this headline">¶</a></h2>
<p>Create 4 files:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">variables.tf</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>variable qa_bigip {}
variable prod_bigip {}
variable username {}
variable password {}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">inputs.auto.tfvars</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>qa_bigip = &quot;10.1.1.9:443&quot;
prod_bigip = &quot;10.1.1.8:443&quot;
username = &quot;admin&quot;
password = &quot;whatIsYourBigIPPassword?&quot;
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">main.tf</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span>terraform {
  required_providers {
    bigip = {
      source = &quot;F5Networks/bigip&quot;
      version = &quot;1.15&quot;
    }
  }
}
provider &quot;bigip&quot; {
  alias    = &quot;qa&quot;
  address  = var.qa_bigip
  username = var.username
  password = var.password
}
provider &quot;bigip&quot; {
  alias    = &quot;prod&quot;
  address  = var.prod_bigip
  username = var.username
  password = var.password
}

data &quot;http&quot; &quot;scenario4&quot; {
  url = &quot;https://raw.githubusercontent.com/fchmainy/awaf_tf_docs/main/0.Appendix/scenario4.json&quot;
  request_headers = {
     Accept = &quot;application/json&quot;
  }
}

resource &quot;bigip_waf_policy&quot; &quot;s4_qa&quot; {
    provider          = bigip.qa
    application_language = &quot;utf-8&quot;
    partition            = &quot;Common&quot;
    name                 = &quot;scenario4&quot;
    template_name        = &quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;
    type                 = &quot;security&quot;
    policy_import_json   = data.http.scenario4.body
}

resource &quot;bigip_waf_policy&quot; &quot;s4_prod&quot; {
    provider          = bigip.prod
    application_language = &quot;utf-8&quot;
    partition            = &quot;Common&quot;
    name                 = &quot;scenario4&quot;
    template_name        = &quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;
    type                 = &quot;security&quot;
    policy_import_json   = data.http.scenario4.body
}
</pre></div>
</td></tr></table></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The template name can be set to anything. When it is imported, the value is overwritten.</p>
</div>
<p>Here, we are referencing an existing policy from a GitHub repository but it can also be created from zero on both BIG-IPs.</p>
<p>Initialize, plan, and apply your new Terraform project.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ terraform init
Initializing the backend...

Initializing provider plugins...
[...]
Terraform has been successfully initialized!

foo@bar:~$ terraform plan -out scenario4 &gt; output_scenario4.1
foo@bar:~$ more output_scenario4.1
foo@bar:~$ terraform apply &quot;scenario4&quot;
</pre></div>
</div>
<p>You can check on both BIG-IPs, the two policies are here and very consistent.</p>
</div>
<div class="section" id="simulate-a-waf-policy-workflow">
<h2>Simulate a WAF Policy workflow<a class="headerlink" href="#simulate-a-waf-policy-workflow" title="Permalink to this headline">¶</a></h2>
<p>Here is a common workflow:</p>
<ol class="arabic simple">
<li>Enforce attack signatures on the QA environment.</li>
<li>Check if these changes do not break the application and identify potential False Positives.</li>
<li>Apply the changes on QA before applying them on Production.</li>
</ol>
<div class="section" id="enforcing-attack-signatures-on-the-qa-environment">
<h3>Enforcing attack signatures on the QA environment<a class="headerlink" href="#enforcing-attack-signatures-on-the-qa-environment" title="Permalink to this headline">¶</a></h3>
<p>In order to track attack signature changes, use a Terraform HCL map. Add this signature list definition in the <strong>inputs.auto.tfvars</strong> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">signatures</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">200101559</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="mi">200101559</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;src http: (Header)&quot;</span>
        <span class="n">enabled</span>         <span class="o">=</span> <span class="n">true</span>
        <span class="n">perform_staging</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="mi">200101558</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="mi">200101558</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;src http: (Parameter)&quot;</span>
        <span class="n">enabled</span>         <span class="o">=</span> <span class="n">true</span>
        <span class="n">perform_staging</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="mi">200003067</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="mi">200003067</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/..namedfork/data</span><span class="se">\&quot;</span><span class="s2"> execution attempt (Headers)&quot;</span>
        <span class="n">enabled</span>         <span class="o">=</span> <span class="n">true</span>
        <span class="n">perform_staging</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="mi">200003066</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="mi">200003066</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/..namedfork/data</span><span class="se">\&quot;</span><span class="s2"> execution attempt (Parameters)&quot;</span>
        <span class="n">enabled</span>         <span class="o">=</span> <span class="n">true</span>
        <span class="n">perform_staging</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>
    <span class="mi">200003068</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="mi">200003068</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">/..namedfork/data</span><span class="se">\&quot;</span><span class="s2"> execution attempt (URI)&quot;</span>
        <span class="n">enabled</span>         <span class="o">=</span> <span class="n">true</span>
        <span class="n">perform_staging</span> <span class="o">=</span> <span class="n">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Create a <strong>signatures.tf</strong> file with a map to all the attack signatures defied previously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">variable</span> <span class="s2">&quot;signatures&quot;</span> <span class="p">{</span>
  <span class="nb">type</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">object</span><span class="p">({</span>
        <span class="n">signature_id</span>    <span class="o">=</span> <span class="n">number</span>
    <span class="n">enabled</span>         <span class="o">=</span> <span class="nb">bool</span>
    <span class="n">perform_staging</span> <span class="o">=</span> <span class="nb">bool</span>
        <span class="n">description</span>     <span class="o">=</span> <span class="n">string</span>
  <span class="p">}))</span>
<span class="p">}</span>


<span class="n">data</span> <span class="s2">&quot;bigip_waf_signatures&quot;</span> <span class="s2">&quot;map_qa&quot;</span> <span class="p">{</span>
  <span class="n">provider</span>          <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">qa</span>
  <span class="n">for_each</span>          <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">signatures</span>
  <span class="n">signature_id</span>              <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;signature_id&quot;</span><span class="p">]</span>
  <span class="n">description</span>               <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
  <span class="n">enabled</span>           <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span>
  <span class="n">perform_staging</span>   <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;perform_staging&quot;</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">data</span> <span class="s2">&quot;bigip_waf_signatures&quot;</span> <span class="s2">&quot;map_prod&quot;</span> <span class="p">{</span>
  <span class="n">provider</span>          <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">prod</span>
  <span class="n">for_each</span>          <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">signatures</span>
  <span class="n">signature_id</span>              <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;signature_id&quot;</span><span class="p">]</span>
  <span class="n">description</span>               <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
  <span class="n">enabled</span>           <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;enabled&quot;</span><span class="p">]</span>
  <span class="n">perform_staging</span>   <span class="o">=</span> <span class="n">each</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;perform_staging&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>In this example, we defined two different maps: one for the QA BIG-IP and one for the PRODUCTION BIG-IP because the “bigip_waf_signatures” data source are linked to their BIG-IP for consistency. Unlike the parameters and URLs data sources which are just “json payload generators”, the attack signature data sources has to first read the existence of the signature IDs and their status on the BIG-IP before applying a configuration change.</p>
<p>Finally, update the <strong>main.tf</strong> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resource</span> <span class="s2">&quot;bigip_waf_policy&quot;</span> <span class="s2">&quot;s4_qa&quot;</span> <span class="p">{</span>
    <span class="n">provider</span>                 <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">qa</span>
    <span class="n">application_language</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="n">partition</span>            <span class="o">=</span> <span class="s2">&quot;Common&quot;</span>
    <span class="n">name</span>                 <span class="o">=</span> <span class="s2">&quot;scenario4&quot;</span>
    <span class="n">template_name</span>        <span class="o">=</span> <span class="s2">&quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;</span>
    <span class="nb">type</span>                 <span class="o">=</span> <span class="s2">&quot;security&quot;</span>
    <span class="n">policy_import_json</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">scenario4</span><span class="o">.</span><span class="n">body</span>
    <span class="n">signatures</span>           <span class="o">=</span> <span class="p">[</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">bigip_waf_signatures</span><span class="o">.</span><span class="n">map_qa</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">json</span> <span class="p">]</span>
<span class="p">}</span>

<span class="n">resource</span> <span class="s2">&quot;bigip_waf_policy&quot;</span> <span class="s2">&quot;s4_prod&quot;</span> <span class="p">{</span>
    <span class="n">provider</span>                 <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">prod</span>
    <span class="n">application_language</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="n">partition</span>            <span class="o">=</span> <span class="s2">&quot;Common&quot;</span>
    <span class="n">name</span>                 <span class="o">=</span> <span class="s2">&quot;scenario4&quot;</span>
    <span class="n">template_name</span>        <span class="o">=</span> <span class="s2">&quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;</span>
    <span class="nb">type</span>                 <span class="o">=</span> <span class="s2">&quot;security&quot;</span>
    <span class="n">policy_import_json</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">scenario4</span><span class="o">.</span><span class="n">body</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Plan and apply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ terraform plan -out scenario4 &gt; output_scenario4.2
foo@bar:~$ more output_scenario4.2
foo@bar:~$ terraform apply &quot;scenario4&quot;
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>You can verify that the 5 attack signatures have been enabled and enforced on the scenario4 WAF Policy on the QA BIG-IP (first 5 lines in the attack signatures list of the Advanced WAF Policy).</p>
<p>The applicatiopn owner identified that these last changes on the QA device have introduced some FP. Using the log events on the F5 BIG-IP Advanced WAF GUI, we identified that :</p>
<ul class="simple">
<li>The attack signature <strong>“200101558”</strong> should be disabled globally</li>
<li>The attack signature <strong>“200003068”</strong> should be disabled for the <strong>“/U1”</strong> URL</li>
<li>The attack signaure <strong>“200003067”</strong> should be enabled globally but disabled specifically for the parameter “P1”.</li>
</ul>
<p>Proceed to the final changes before enforcing into production:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">inputs.auto.tfvars</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="highlight"><pre><span></span>signatures = {
    200101559 = {
        signature_id    = 200101559
        description     = &quot;src http: (Header)&quot;
        enabled         = true
        perform_staging = false
    }
    200101558 = {
        signature_id    = 200101558
        description     = &quot;src http: (Parameter)&quot;
        enabled         = false
        perform_staging = false
    }
    200003067 = {
        signature_id    = 200003067
        description     = &quot;\&quot;/..namedfork/data\&quot; execution attempt (Headers)&quot;
        enabled         = true
        perform_staging = false
    }
    200003066 = {
        signature_id    = 200003066
        description     = &quot;\&quot;/..namedfork/data\&quot; execution attempt (Parameters)&quot;
        enabled         = true
        perform_staging = false
    }
    200003068 = {
        signature_id    = 200003068
        description     = &quot;\&quot;/..namedfork/data\&quot; execution attempt (URI)&quot;
        enabled         = true
        perform_staging = false
    }
}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">parameters.tf</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>data &quot;bigip_waf_entity_parameter&quot; &quot;P1&quot; {
  name                       = &quot;P1&quot;
  type                       = &quot;explicit&quot;
  data_type                  = &quot;alpha-numeric&quot;
  perform_staging            = true
  signature_overrides_disable        = [200003067]
  //url                              = data.bigip_waf_entity_url.U1
}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">urls.tf</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>data &quot;bigip_waf_entity_url&quot; &quot;U1&quot; {
  name                               = &quot;/U1&quot;
  type                               = &quot;explicit&quot;
  perform_staging                    = false
  signature_overrides_disable        = [200003068]
}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Update the <strong>main.tf</strong> file:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">main.tf</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span>resource &quot;bigip_waf_policy&quot; &quot;s4_qa&quot; {
    provider          = bigip.qa
    application_language = &quot;utf-8&quot;
    partition            = &quot;Common&quot;
    name                 = &quot;scenario4&quot;
    template_name        = &quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;
    type                 = &quot;security&quot;
    policy_import_json   = data.http.scenario4.body
    signatures                = [ for k,v in data.bigip_waf_signatures.map_qa: v.json ]
    parameters                = [data.bigip_waf_entity_parameter.P1.json]
    urls              = [data.bigip_waf_entity_url.U1.json]
}

resource &quot;bigip_waf_policy&quot; &quot;s4_prod&quot; {
    provider          = bigip.prod
    application_language = &quot;utf-8&quot;
    partition            = &quot;Common&quot;
    name                 = &quot;scenario4&quot;
    template_name        = &quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;
    type                 = &quot;security&quot;
    policy_import_json   = data.http.scenario4.body
    signatures                = [ for k,v in data.bigip_waf_signatures.map_prod: v.json ]
    parameters                = [data.bigip_waf_entity_parameter.P1.json]
    urls              = [data.bigip_waf_entity_url.U1.json]
}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Play and apply:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ terraform plan -out scenario4 &gt; output_scenario4.3
foo@bar:~$ more output_scenario4.3
foo@bar:~$ terraform apply &quot;scenario4&quot;
</pre></div>
</div>
<p>What’s Next?</p>
<ul class="simple">
<li><a class="reference internal" href="awaf-create.html#awaf-create"><span class="std std-ref">Create a WAF policy</span></a></li>
<li><a class="reference internal" href="awaf-import.html#awaf-import"><span class="std std-ref">Manage existing WAF policy</span></a></li>
<li><a class="reference internal" href="awaf-migrate.html#awaf-migrate"><span class="std std-ref">Migrate WAF policy from one BIG-IP to another</span></a></li>
<li><a class="reference internal" href="awaf-policybuildersingle.html#awaf-policybuildersingle"><span class="std std-ref">Using WAF policy builder to manage a single device</span></a></li>
<li><a class="reference internal" href="awaf-policybuildermultiple.html#awaf-policybuildermultiple"><span class="std std-ref">Using WAF policy builder to manage multiple devices</span></a></li>
<li><a class="reference internal" href="../release-notes.html#release-notes"><span class="std std-ref">Release Notes</span></a></li>
</ul>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="awaf-migrate.html" title="Scenario #3: Migrating a WAF Policy from one BIG-IP to another BIG-IP" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="awaf-policybuildersingle.html" title="Scenario #5: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on a single device" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  </body>
</html>