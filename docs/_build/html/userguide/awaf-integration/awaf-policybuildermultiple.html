<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices"/>
  <meta name="product" content="F5 BIG-IP Resources for Terraform"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2023-04-26 11:52:19"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 BIG-IP Resources for Terraform" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices &#8212; F5 Modules for Terraform</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/table_styling.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <script type="text/javascript" src="../../_static/copybutton.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="FAST Integration with Terraform" href="../fast-integration/index.html" />
    <link rel="prev" title="Scenario #5: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on a single device" href="awaf-policybuildersingle.html" />

  
    

  
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="dismiss">
      <button type="button" class="btn btn-info navbar-btn site-hidden">
        <i class="fa fa-align-justify"></i>
      </button>
    </div>
    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 BIG-IP Resources for Terraform  </h5>
        
<div id="searchbox" role="search">
  <form class="search" action="../../search.html" method="get">
    <input type="text" class="search" name="q" placeholder=" Search..." />
    <button type="submit" class="btn btn-info navbar-btn"><i class="fa fa-search"></i></button>
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">F5 Terraform Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">F5 Terraform Resources Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installing Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuring.html">Configuring Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support.html">Support</a></li>
</ul>
<p class="caption"><span class="caption-text">F5 BIG-IP Provider</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index-bigip.html">F5 BIG-IP Provider Overview</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index-bigip.html#releases-and-versioning">Releases and Versioning</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">F5 BIG-IP Provider Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bigip-modules/index.html">F5 BIG-IP Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../as3-integration.html">AS3 Integration with Terraform</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Advanced WAF Integration with Terraform</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#example-usage">Example Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#integration-resources-and-data-sources">Integration Resources and Data Sources</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#quickstart-and-lab-guides">Quickstart and Lab Guides</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../fast-integration/index.html">FAST Integration with Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../do-integration.html">Declarative Onboarding Integration with Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bigiq-licensing.html">Licensing BIG-IP with BIG-IQ</a></li>
</ul>
<p class="caption"><span class="caption-text">F5OS Provider</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/index-f5os.html">F5OS Resources for Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/release-notes.html">F5OS Provider Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/f5os-modules.html">F5OS Tenant Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../F5OS/f5os-qsg.html">F5OS Quick Start Guide</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices</a><ul>
<li><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li><a class="reference internal" href="#policy-creation">Policy Creation</a></li>
<li><a class="reference internal" href="#simulate-a-waf-policy-workflow">Simulate a WAF Policy workflow</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
            <nav class="site-breadcrumb-nav site-nav">
          <ul class="site-breadcrumb-list">
            <li class="breadcrumb-item"><button type="button" id="sidebarCollapse" class="btn btn-info navbar-btn site-hidden"><i class="fa fa-align-justify"></i></button>&#x20 <a href="/">CloudDocs Home</a> &gt; <a href="../../index.html">F5 BIG-IP Resources for Terraform </a> &gt; Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices</li>
          </ul>
      </nav>
      
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="scenario-6-managing-an-f5-big-ip-advanced-waf-policy-with-policy-builder-on-multiple-devices">
<span id="awaf-policybuildermultiple"></span><h1>Scenario #6: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on multiple devices<a class="headerlink" href="#scenario-6-managing-an-f5-big-ip-advanced-waf-policy-with-policy-builder-on-multiple-devices" title="Permalink to this headline">¶</a></h1>
<p>The goal of this lab is to manage Policy Builder Suggestions an F5 BIG-IP Advanced WAF Policy from on multiple devices or clusters. Use cases include:</p>
<ul class="simple">
<li>Multiple devices serving and protecting the same application (multiple datacenters, application spanned across multiple clouds, etc.) By nature, each standalone device or clusters can see different traffic patterns so the suggestions can be different. The goal here is to consolidate the suggestions before enforcing them.</li>
<li>Production BIG-IP systems protecting the application therefore seeing the real life traffic flow for seeding the Policy Builder but all changes need to be first validated in the qualification environment before enforcing into production.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These two uses cases are not mutually exclusive and can be managed within a single workflow.</p>
</div>
<div class="section" id="pre-requisites">
<h2>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<p>On the BIG-IP:</p>
<ul class="simple">
<li>BIG-IP version 16.1 or newer</li>
<li>Advanced WAF Provisioned</li>
<li>Credentials with REST API access</li>
<li>An Advanced WAF Policy with Policy Builder enabled and Manual traffic Learning</li>
</ul>
<p>On Terraform:</p>
<ul class="simple">
<li>Using F5 BIG-IP provider version 1.16.0 or newer</li>
<li>Using Hashicorp versions following <a class="reference internal" href="../index-bigip.html#versions"><span class="std std-ref">Releases and Versioning</span></a></li>
</ul>
</div>
<div class="section" id="policy-creation">
<h2>Policy Creation<a class="headerlink" href="#policy-creation" title="Permalink to this headline">¶</a></h2>
<p>Create 4 files:</p>
<ul class="simple">
<li>variables.tf</li>
<li>inputs.auto.tfvars</li>
<li>main.tf</li>
<li>outputs.tf</li>
</ul>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">variables.tf</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span>variable prod_dc1_bigip {}
variable prod_cloud_bigip {}
variable qa_bigip {}
variable username {}
variable password {}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">inputs.auto.tfvars</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span>prod_dc1_bigip = &quot;10.1.1.8&quot;
prod_cloud_bigip = &quot;10.1.1.7&quot;
qa_bigip = &quot;10.1.1.9&quot;
username = &quot;admin&quot;
password = &quot;WhatisYourPassword?&quot;
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">main.tf</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span>terraform {
  required_providers {
    bigip = {
      source                         = &quot;F5Networks/bigip&quot;
      version                        = &quot;1.15&quot;
    }
  }
}

provider &quot;bigip&quot; {
  alias                      = &quot;prod1&quot;
  address                    = var.prod_dc1_bigip
  username                   = var.username
  password                   = var.password
}

provider &quot;bigip&quot; {
  alias                      = &quot;prod2&quot;
  address                    = var.prod_cloud_bigip
  username                   = var.username
  password                   = var.password
}

provider &quot;bigip&quot; {
  alias                      = &quot;qa&quot;
  address                    = var.qa_bigip
  username                   = var.username
  password                   = var.password
}

resource &quot;bigip_waf_policy&quot; &quot;P1S6&quot; {
    provider                 = bigip.prod1
    application_language     = &quot;utf-8&quot;
    partition                        = &quot;Common&quot;
    name                     = &quot;scenario6&quot;
    enforcement_mode         = &quot;blocking&quot;
    template_name            = &quot;POLICY_TEMPLATE_RAPID_DEPLOYMENT&quot;
}

resource &quot;bigip_waf_policy&quot; &quot;P2S6&quot; {
    provider                    = bigip.prod2
    application_language     = &quot;utf-8&quot;
    partition                   = &quot;Common&quot;
    name                     = &quot;scenario6&quot;
    enforcement_mode         = &quot;blocking&quot;
    template_name            = &quot;POLICY_TEMPLATE_RAPID_DEPLOYMENT&quot;
}

resource &quot;bigip_waf_policy&quot; &quot;QAS6&quot; {
    provider                    = bigip.qa
    application_language     = &quot;utf-8&quot;
    partition                   = &quot;Common&quot;
    name                     = &quot;scenario6&quot;
    enforcement_mode         = &quot;blocking&quot;
    template_name            = &quot;POLICY_TEMPLATE_RAPID_DEPLOYMENT&quot;
}
</pre></div>
</td></tr></table></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">outputs.tf</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-json notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>output &quot;P1S6Id&quot; {
        value        = bigip_waf_policy.P1S6.policy_id
}
output &quot;P1S6JSON&quot; {
        value   = bigip_waf_policy.P1S6.policy_export_json
}
output &quot;P2S6Id&quot; {
        value        = bigip_waf_policy.P2S6.policy_id
}
output &quot;P2S6JSON&quot; {
        value   = bigip_waf_policy.P2S6.policy_export_json
}
output &quot;QAS6Id&quot; {
        value        = bigip_waf_policy.QAS6.policy_id
}
output &quot;QAS6JSON&quot; {
        value   = bigip_waf_policy.QAS6.policy_export_json
}
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="simulate-a-waf-policy-workflow">
<h2>Simulate a WAF Policy workflow<a class="headerlink" href="#simulate-a-waf-policy-workflow" title="Permalink to this headline">¶</a></h2>
<p>Here is a typical workflow:</p>
<p>On each BIG-IP, there is a <strong>scenario6.vs</strong> Virtual Server.</p>
<ol class="arabic simple">
<li>Create and associate the same WAF Policy to these Virtual Servers.</li>
<li>Run traffic on Production devices. Make sure you are not running the same requests on both Production devices: get distinct suggestions.</li>
<li>Test the suggestions from Prod1 and Prod2 devices on the QA device and check that the application is not broken.</li>
<li>Enforce suggestions on the Production devices.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are some changes that may be specific to the QA environment, such as setting Trusted IP addresses. So we will make the specific tuning first.</p>
</div>
<p>1. Policy creation and association
Plan and apply your new Terraform project.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>foo@bar:~$ terraform init

foo@bar:~$ terraform plan -out scenario6

foo@bar:~$ terraform apply &quot;scenario6&quot;
</pre></div>
</div>
</div></blockquote>
<p>Now go on your WebUI and associate the WAF Policies to the scenario6.vs Virtual Servers. (here we do it manually but it can definitely be done using the “bigip_as3” terraform resource from the same Terraform “F5Networks/bigip” provider).</p>
<p>2. Running Real life traffic
Now, run both legitimate AND illegitimate traffic against your two production BIG-IP devices (scenario6 virtual servers on PROD1 and PROD2 BIG-IPs). Try to throw different attacks on each devices so we make sure we collect different Policy Builder suggestions (checkout the recommended steps described on Module5).</p>
<p>You may have to run multiple time the same request to make sure we get a satisfying learning score.</p>
<p>3. Collect and test the Policy Builder suggestions.
Create a pb_suggestions.tf file:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="s2">&quot;bigip_waf_pb_suggestions&quot;</span> <span class="s2">&quot;S6_22AUG20221800_P1&quot;</span> <span class="p">{</span>
  <span class="n">provider</span>                 <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">prod1</span>
  <span class="n">policy_name</span>            <span class="o">=</span> <span class="s2">&quot;scenario6&quot;</span>
  <span class="n">partition</span>              <span class="o">=</span> <span class="s2">&quot;Common&quot;</span>
  <span class="n">minimum_learning_score</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">}</span>

<span class="n">data</span> <span class="s2">&quot;bigip_waf_pb_suggestions&quot;</span> <span class="s2">&quot;S6_22AUG20221800_P2&quot;</span> <span class="p">{</span>
  <span class="n">provider</span>                 <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">prod2</span>
  <span class="n">policy_name</span>            <span class="o">=</span> <span class="s2">&quot;scenario6&quot;</span>
  <span class="n">partition</span>              <span class="o">=</span> <span class="s2">&quot;Common&quot;</span>
  <span class="n">minimum_learning_score</span> <span class="o">=</span> <span class="mi">100</span>
<span class="p">}</span>

<span class="n">output</span> <span class="s2">&quot;PB_S6_22AUG20221800_P1&quot;</span> <span class="p">{</span>
  <span class="n">value</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bigip_waf_pb_suggestions</span><span class="o">.</span><span class="n">S6_22AUG20221800_P1</span><span class="o">.</span><span class="n">json</span>
<span class="p">}</span>

<span class="n">output</span> <span class="s2">&quot;PB_S6_22AUG20221800_P2&quot;</span> <span class="p">{</span>
  <span class="n">value</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">bigip_waf_pb_suggestions</span><span class="o">.</span><span class="n">S6_22AUG20221800_P2</span><span class="o">.</span><span class="n">json</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>Update the main.tf file on the scenario6 QA WAF Policy resource:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">resource</span> <span class="s2">&quot;bigip_waf_policy&quot;</span> <span class="s2">&quot;QAS6&quot;</span> <span class="p">{</span>
    <span class="n">provider</span>               <span class="o">=</span> <span class="n">bigip</span><span class="o">.</span><span class="n">qa</span>
    <span class="n">application_language</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span>
    <span class="n">name</span>                 <span class="o">=</span> <span class="s2">&quot;scenario6&quot;</span>
    <span class="n">partition</span>            <span class="o">=</span> <span class="s2">&quot;Common&quot;</span>
    <span class="n">template_name</span>        <span class="o">=</span> <span class="s2">&quot;POLICY_TEMPLATE_FUNDAMENTAL&quot;</span>
    <span class="nb">type</span>                 <span class="o">=</span> <span class="s2">&quot;security&quot;</span>
    <span class="n">policy_import_json</span>   <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">http</span><span class="o">.</span><span class="n">scenario6</span><span class="o">.</span><span class="n">body</span>
    <span class="n">modifications</span>        <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">bigip_waf_pb_suggestions</span><span class="o">.</span><span class="n">S6_22AUG20221800_P1</span><span class="o">.</span><span class="n">json</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">bigip_waf_pb_suggestions</span><span class="o">.</span><span class="n">S6_22AUG20221800_P2</span><span class="o">.</span><span class="n">json</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are obviously some redundant learning suggestions on both data sources but the Declarative WAF API automatically removes them.</p>
</div>
</div></blockquote>
<p>Now you can test your application through the QA device.</p>
<p>For UDF users: check <a class="reference external" href="https://qa.f5demo.fch">https://qa.f5demo.fch</a> and see that the application is not broken and attacks are blocked</p>
<p>4. Enforce suggestions on the Production devices
In a real life scenario, there are two ways we can consider this step:</p>
<ol class="loweralpha simple">
<li>the QA device WAF Policy should be 100% consistent with production devices</li>
<li>the QA device WAF Policy may have settings differences with production devices (Trusted IP exceptions for example)</li>
</ol>
<p>a) QA.WAF == PROD.WAF
That is the easiest way. After validating the suggestions and removing the potential False Positives, just output the JSON policy from QA and refer to it as a policy_import_json argument in the production BIG-IPs</p>
<p>In this case, update the main.tf file</p>
<blockquote>
<div><dl class="docutils">
<dt>resource “bigip_waf_policy” “P1S6” {</dt>
<dd>provider                 = bigip.prod1
application_language     = “utf-8”
partition                        = “Common”
name                     = “scenario6”
enforcement_mode         = “blocking”
template_name            = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”
policy_import_json          = bigip_waf_policy.QAS6.policy_export_json</dd>
</dl>
<p>}</p>
<dl class="docutils">
<dt>resource “bigip_waf_policy” “P2S6” {</dt>
<dd>provider                 = bigip.prod2
application_language     = “utf-8”
partition                        = “Common”
name                     = “scenario6”
enforcement_mode         = “blocking”
template_name            = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”
policy_import_json          = bigip_waf_policy.QAS6.policy_export_json</dd>
</dl>
<p>}</p>
<dl class="docutils">
<dt>resource “bigip_waf_policy” “QAS6” {</dt>
<dd>provider                 = bigip.qa
application_language     = “utf-8”
partition                   = “Common”
name                     = “scenario6”
enforcement_mode         = “blocking”
template_name            = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”</dd>
</dl>
<p>}</p>
</div></blockquote>
<p>now, plan &amp; apply!:</p>
<blockquote>
<div><a class="reference external" href="mailto:foo&#37;&#52;&#48;bar">foo<span>&#64;</span>bar</a>:~$ terraform plan -out scenario6
<a class="reference external" href="mailto:foo&#37;&#52;&#48;bar">foo<span>&#64;</span>bar</a>:~$ terraform apply “scenario6”</div></blockquote>
<p>b) QA.WAF != PROD.WAF
In this case, we need to manage the learning suggestions as a separate modifications entity that has to move between WAF Policies.</p>
<p>The learning suggestions, when imported into the QA WAF Policy, are deduplicated and ingested into the WAF Policy. However, they remain in a dedicated space of the Declarative REST JSON: the modifications array. So, the goal is to import only this section back to the production devices, so any differences in the core entities are not affected.</p>
<dl class="docutils">
<dt>resource “bigip_waf_policy” “P1S6” {</dt>
<dd>provider                    = bigip.prod1
application_language        = “utf-8”
partition                   = “Common”
name                        = “scenario6”
enforcement_mode            = “blocking”
template_name               = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”
policy_import_json          = bigip_waf_policy.QAS6.policy_export_json.modifications</dd>
</dl>
<p>}</p>
<dl class="docutils">
<dt>resource “bigip_waf_policy” “P2S6” {</dt>
<dd>provider                    = bigip.prod2
application_language        = “utf-8”
partition                   = “Common”
name                        = “scenario6”
enforcement_mode            = “blocking”
template_name               = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”
policy_import_json          = bigip_waf_policy.QAS6.policy_export_json.modifications</dd>
</dl>
<p>}</p>
<dl class="docutils">
<dt>resource “bigip_waf_policy” “QAS6” {</dt>
<dd>provider                    = bigip.qa
application_language        = “utf-8”
partition                   = “Common”
name                        = “scenario6”
enforcement_mode            = “blocking”
template_name               = “POLICY_TEMPLATE_RAPID_DEPLOYMENT”</dd>
</dl>
<p>}
now, plan &amp; apply!:</p>
<p><a class="reference external" href="mailto:foo&#37;&#52;&#48;bar">foo<span>&#64;</span>bar</a>:~$ terraform plan -out scenario6
<a class="reference external" href="mailto:foo&#37;&#52;&#48;bar">foo<span>&#64;</span>bar</a>:~$ terraform apply “scenario6”</p>
<p>What’s Next?</p>
<ul class="simple">
<li><a class="reference internal" href="awaf-create.html#awaf-create"><span class="std std-ref">Create a WAF policy</span></a></li>
<li><a class="reference internal" href="awaf-import.html#awaf-import"><span class="std std-ref">Manage existing WAF policy</span></a></li>
<li><a class="reference internal" href="awaf-migrate.html#awaf-migrate"><span class="std std-ref">Migrate WAF policy from one BIG-IP to another</span></a></li>
<li><a class="reference internal" href="awaf-multiple.html#awaf-multiple"><span class="std std-ref">Manage WAF policies for multiple devices</span></a></li>
<li><a class="reference internal" href="awaf-policybuildersingle.html#awaf-policybuildersingle"><span class="std std-ref">Using WAF policy builder to manage a single device</span></a></li>
<li><a class="reference internal" href="../release-notes.html#release-notes"><span class="std std-ref">Release Notes</span></a></li>
</ul>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="awaf-policybuildersingle.html" title="Scenario #5: Managing an F5 BIG-IP Advanced WAF Policy with Policy Builder on a single device" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="../fast-integration/index.html" title="FAST Integration with Terraform" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  </body>
</html>